<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirTraffic Command Center Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .dashboard-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .navbar {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 20px;
        }
        .team-info {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        .team-score {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            margin-right: 15px;
        }
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .map-container {
            flex: 3;
            height: 100%;
            position: relative;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .sidebar {
            flex: 1;
            background-color: #f8f9fa;
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            min-width: 300px;
            max-width: 400px;
            border-left: 1px solid #dee2e6;
        }
        .challenge-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }
        .challenge-card h5 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .challenge-card p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        .phase-indicator {
            background-color: #e1f0fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .phase-indicator h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .progress {
            height: 8px;
            margin-top: 10px;
        }
        .aircraft-info {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-top: 20px;
        }
        .aircraft-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .aircraft-item {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .aircraft-item:hover {
            background-color: #f0f8ff;
        }
        .aircraft-detail {
            display: none;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 10px;
        }
        .control-panel {
            background-color: rgba(255,255,255,0.9);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 10px;
        }
        .filter-control {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Navigation Bar -->
        <nav class="navbar">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-airplane me-2" viewBox="0 0 16 16">
                        <path d="M6.428 1.151C6.708.591 7.213 0 8 0s1.292.591 1.572 1.151C9.861 1.73 10 2.431 10 3v3.691l5.17 2.585a1.5 1.5 0 0 1 .83 1.342V12a.5.5 0 0 1-.582.493l-5.507-.918-.375 2.253 1.318 1.318A.5.5 0 0 1 10.5 16h-5a.5.5 0 0 1-.354-.854l1.319-1.318-.376-2.253-5.507.918A.5.5 0 0 1 0 12v-1.382a1.5 1.5 0 0 1 .83-1.342L6 6.691V3c0-.568.14-1.271.428-1.849Z"/>
                    </svg>
                    AirTraffic Command Center
                </span>
                <div class="team-info">
                    <div class="team-score">Score: <span id="team-score">{{ team_score }}</span></div>
                    <div class="team-name">Team: {{ team_name }}</div>
                    <a href="/logout" class="btn btn-outline-light btn-sm ms-3">Logout</a>
                </div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Flight Map -->
            <div class="map-container">
                <div id="map"></div>
                
                <!-- Control Panel for Filters -->
                <div class="control-panel">
                    <h6>Filters</h6>
                    <div class="filter-control">
                        <label for="altitude-filter" class="form-label">Min Altitude:</label>
                        <input type="range" class="form-range" id="altitude-filter" min="0" max="40000" step="1000" value="0">
                        <div class="d-flex justify-content-between">
                            <small>0 ft</small>
                            <small>40,000 ft</small>
                        </div>
                    </div>
                    <div class="filter-control">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="show-paths">
                            <label class="form-check-label" for="show-paths">Show Flight Paths</label>
                        </div>
                    </div>
                    <button id="reset-filters" class="btn btn-sm btn-outline-secondary w-100">Reset Filters</button>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Current Challenge Phase -->
                <div class="phase-indicator">
                    <h4>{{ current_challenge.phase_name }}</h4>
                    <p>Time Remaining: <span id="time-remaining">{{ current_challenge.time_remaining }}</span></p>
                    <div class="progress">
                        <div class="progress-bar bg-info" role="progressbar" style="width: {{ current_challenge.progress_percent }}%" aria-valuenow="{{ current_challenge.progress_percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                
                <!-- Challenge Cards -->
                <h5>Current Challenges</h5>
                {% for challenge in current_challenge.challenges %}
                <div class="challenge-card" id="challenge-{{ challenge.id }}">
                    <h5>{{ challenge.title }}</h5>
                    <p>{{ challenge.description }}</p>
                    <p><small class="text-muted">Points: {{ challenge.points }}</small></p>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="answer-{{ challenge.id }}" placeholder="Enter your answer">
                    </div>
                    <button class="btn btn-primary btn-sm submit-answer" data-challenge-id="{{ challenge.id }}">Submit Answer</button>
                    <div class="feedback mt-2" id="feedback-{{ challenge.id }}"></div>
                </div>
                {% endfor %}
                
                <!-- Aircraft Information -->
                <div class="aircraft-info">
                    <h5>Aircraft List</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="search-aircraft" placeholder="Search by callsign or hex">
                        <button class="btn btn-outline-secondary" type="button" id="search-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="aircraft-list" id="aircraft-list">
                        <!-- Aircraft items will be populated via JavaScript -->
                    </div>
                    <div class="aircraft-detail" id="aircraft-detail">
                        <!-- Selected aircraft details will be shown here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Initialize map
        const map = L.map('map').setView([14.5, 74.0], 7);
        
        // Add tile layer (map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Aircraft markers and data
        let aircraftMarkers = {};
        let aircraftData = {};
        let minAltitudeFilter = 0;
        let showPaths = false;
        
        // Aircraft icon
        const aircraftIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61212.png',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        
        // Update aircraft data from server
        function updateAircraftData() {
            axios.get('/api/aircraft')
                .then(response => {
                    const data = response.data;
                    aircraftData = {};
                    
                    // Process aircraft data
                    if (data && data.aircraft) {
                        data.aircraft.forEach(aircraft => {
                            aircraftData[aircraft.hex] = aircraft;
                        });
                        
                        // Update map and list
                        updateMap();
                        updateAircraftList();
                    }
                })
                .catch(error => {
                    console.error('Error fetching aircraft data:', error);
                });
        }
        
        // Update aircraft markers on the map
        function updateMap() {
            // Apply altitude filter
            const filteredAircraft = Object.values(aircraftData).filter(aircraft => {
                return aircraft.altitude >= minAltitudeFilter;
            });
            
            // Add/update markers for each aircraft
            filteredAircraft.forEach(aircraft => {
                const position = [aircraft.lat, aircraft.lon];
                
                // Rotate marker based on track
                const rotationAngle = aircraft.track || 0;
                
                if (aircraftMarkers[aircraft.hex]) {
                    // Update existing marker
                    aircraftMarkers[aircraft.hex].setLatLng(position);
                    
                    // Update rotation
                    const icon = aircraftMarkers[aircraft.hex].getElement();
                    if (icon) {
                        icon.style.transform = `rotate(${rotationAngle}deg)`;
                    }
                } else {
                    // Create new marker
                    const marker = L.marker(position, { icon: aircraftIcon }).addTo(map);
                    
                    // Rotate marker
                    const icon = marker.getElement();
                    if (icon) {
                        icon.style.transform = `rotate(${rotationAngle}deg)`;
                    }
                    
                    // Add popup with basic info
                    const callsign = aircraft.flight ? aircraft.flight.trim() : 'N/A';
                    marker.bindPopup(`
                        <strong>Flight:</strong> ${callsign}<br>
                        <strong>Altitude:</strong> ${aircraft.altitude} ft<br>
                        <strong>Speed:</strong> ${aircraft.speed} knots<br>
                        <strong>Heading:</strong> ${aircraft.heading}°
                    `);
                    
                    // Add click event
                    marker.on('click', () => {
                        showAircraftDetail(aircraft.hex);
                    });
                    
                    aircraftMarkers[aircraft.hex] = marker;
                }
            });
            
            // Remove markers for aircraft that are no longer visible
            Object.keys(aircraftMarkers).forEach(hex => {
                if (!filteredAircraft.some(a => a.hex === hex)) {
                    map.removeLayer(aircraftMarkers[hex]);
                    delete aircraftMarkers[hex];
                }
            });
        }
        
        // Update aircraft list in sidebar
        function updateAircraftList() {
            const aircraftList = document.getElementById('aircraft-list');
            aircraftList.innerHTML = '';
            
            // Sort aircraft by callsign
            const sortedAircraft = Object.values(aircraftData).sort((a, b) => {
                const callsignA = a.flight ? a.flight.trim() : a.hex;
                const callsignB = b.flight ? b.flight.trim() : b.hex;
                return callsignA.localeCompare(callsignB);
            });
            
            // Add each aircraft to the list
            sortedAircraft.forEach(aircraft => {
                const callsign = aircraft.flight ? aircraft.flight.trim() : 'Unknown';
                const listItem = document.createElement('div');
                listItem.className = 'aircraft-item';
                listItem.dataset.hex = aircraft.hex;
                listItem.innerHTML = `
                    <strong>${callsign}</strong> (${aircraft.altitude} ft)
                `;
                
                listItem.addEventListener('click', () => {
                    showAircraftDetail(aircraft.hex);
                    
                    // Pan map to aircraft
                    map.panTo([aircraft.lat, aircraft.lon]);
                    
                    // Open popup
                    if (aircraftMarkers[aircraft.hex]) {
                        aircraftMarkers[aircraft.hex].openPopup();
                    }
                });
                
                aircraftList.appendChild(listItem);
            });
        }
        
        // Show detailed aircraft information
        function showAircraftDetail(hex) {
            const aircraft = aircraftData[hex];
            if (!aircraft) return;
            
            const detailPanel = document.getElementById('aircraft-detail');
            detailPanel.style.display = 'block';
            
            const callsign = aircraft.flight ? aircraft.flight.trim() : 'Unknown';
            
            detailPanel.innerHTML = `
                <h6>${callsign} (${aircraft.hex})</h6>
                <table class="table table-sm">
                    <tr>
                        <th>Position:</th>
                        <td>${aircraft.lat.toFixed(4)}°, ${aircraft.lon.toFixed(4)}°</td>
                    </tr>
                    <tr>
                        <th>Altitude:</th>
                        <td>${aircraft.altitude} ft</td>
                    </tr>
                    <tr>
                        <th>Speed:</th>
                        <td>${aircraft.speed} knots</td>
                    </tr>
                    <tr>
                        <th>Heading:</th>
                        <td>${aircraft.heading}°</td>
                    </tr>
                    <tr>
                        <th>Squawk:</th>
                        <td>${aircraft.squawk || 'N/A'}</td>
                    </tr>
                </table>
                <button class="btn btn-sm btn-outline-secondary track-aircraft" data-hex="${hex}">Track Aircraft</button>
            `;
            
            // Add event listener for track button
            detailPanel.querySelector('.track-aircraft').addEventListener('click', (e) => {
                const hexToTrack = e.target.dataset.hex;
                // Toggle tracking for this aircraft
                // Implementation would depend on your tracking feature
                alert(`Now tracking aircraft ${callsign}`);
            });
        }
        
        // Handle altitude filter change
        document.getElementById('altitude-filter').addEventListener('input', (e) => {
            minAltitudeFilter = parseInt(e.target.value);
            updateMap();
        });
        
        // Handle show paths toggle
        document.getElementById('show-paths').addEventListener('change', (e) => {
            showPaths = e.target.checked;
            // Implementation for showing paths would go here
        });
        
        // Reset filters
        document.getElementById('reset-filters').addEventListener('click', () => {
            document.getElementById('altitude-filter').value = 0;
            document.getElementById('show-paths').checked = false;
            minAltitudeFilter = 0;
            showPaths = false;
            updateMap();
        });
        
        // Handle aircraft search
        document.getElementById('search-button').addEventListener('click', () => {
            const searchTerm = document.getElementById('search-aircraft').value.toLowerCase();
            const aircraftItems = document.querySelectorAll('.aircraft-item');
            
            aircraftItems.forEach(item => {
                const aircraft = aircraftData[item.dataset.hex];
                if (!aircraft) return;
                
                const callsign = aircraft.flight ? aircraft.flight.trim().toLowerCase() : '';
                const hex = aircraft.hex.toLowerCase();
                
                if (callsign.includes(searchTerm) || hex.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Handle challenge answer submission
        document.querySelectorAll('.submit-answer').forEach(button => {
            button.addEventListener('click', () => {
                const challengeId = button.dataset.challengeId;
                const answer = document.getElementById(`answer-${challengeId}`).value;
                const feedbackElement = document.getElementById(`feedback-${challengeId}`);
                
                // Submit answer to server
                axios.post('/api/submit_answer', {
                    challenge_id: challengeId,
                    answer: answer
                })
                .then(response => {
                    const result = response.data;
                    
                    // Update feedback
                    if (result.is_correct) {
                        feedbackElement.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                        // Update score
                        document.getElementById('team-score').textContent = result.team_score;
                    } else {
                        feedbackElement.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                    }
                })
                .catch(error => {
                    feedbackElement.innerHTML = `<div class="alert alert-danger">Error submitting answer. Please try again.</div>`;
                    console.error('Error submitting answer:', error);
                });
            });
        });
        
        // Update time remaining
        function updateTimeRemaining() {
            const timeElement = document.getElementById('time-remaining');
            if (!timeElement) return;
            
            // This is just a simple countdown for demonstration purposes
            // In a real app, you'd sync with the server
            const currentText = timeElement.textContent;
            const [minutes, seconds] = currentText.split(':').map(num => parseInt(num));
            
            let totalSeconds = minutes * 60 + seconds - 1;
            if (totalSeconds < 0) totalSeconds = 0;
            
            const newMinutes = Math.floor(totalSeconds / 60);
            const newSeconds = totalSeconds % 60;
            
            timeElement.textContent = `${newMinutes.toString().padStart(2, '0')}:${newSeconds.toString().padStart(2, '0')}`;
        }
        
        // Initialize the page
        function initialize() {
            // Initial data load
            updateAircraftData();
            
            // Set up periodic updates
            setInterval(updateAircraftData, 5000); // Update every 5 seconds
            setInterval(updateTimeRemaining, 1000); // Update time every second
        }
        
        // Start everything when the page loads
        window.addEventListener('load', initialize);
    </script>
</body>
</html>